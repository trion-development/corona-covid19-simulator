import { HEIGHT, PERSON_GAP, PERSON_RADIUS, PERSON_SPEED, sicknessInterval, WIDTH } from './constants';
import { Health } from './health.enum';
import { Vector2D } from './vector2d';
var Person = /** @class */ (function () {
    function Person(health, randomNumberGenerator) {
        this.health = health;
        this.positionDiff = new Vector2D(0, 0);
        this.rng = randomNumberGenerator || Math.random;
        this.position = Vector2D.random(this.rng);
        this.position.x *= WIDTH;
        this.position.y *= HEIGHT;
        this.velocity = Person.applySpeed(Vector2D.random(this.rng).sub(new Vector2D(0.5, 0.5)));
        this.socialDistancing = false;
        this.timeToRecovery = Math.floor(sicknessInterval.from + this.rng() * (sicknessInterval.to - sicknessInterval.from));
    }
    Person.applySpeed = function (velocity) {
        return velocity.normalize().mult(PERSON_SPEED);
    };
    Person.reflectBall = function (ball, direction, distanceDiff) {
        direction.normalize();
        // move the ball outside of collision
        var diff = distanceDiff + PERSON_GAP / 2;
        ball.position = ball.position.add(direction.mult(diff));
        direction.normalize();
        // reflect ball, solution: r=dâˆ’2(d*n)n (https://math.stackexchange.com/questions/13261/how-to-get-a-reflection-vector)
        ball.velocity = ball.velocity.sub(direction.mult(2 * ball.velocity.dot(direction)));
    };
    Person.separateBalls = function (ballA, ballB, positionSub, distanceDiff) {
        // move balls outside of collision
        var diff = distanceDiff / 2 + PERSON_GAP;
        var adjustment = positionSub.normalize().mult(diff);
        ballA.position = ballA.position.add(adjustment);
        ballB.position = ballB.position.add(adjustment.negate());
        positionSub.normalize();
    };
    Person.ellasticCollision = function (ballA, ballB, direction, distance) {
        // Elastic collision, but the ball speed is reverted after the collision (no energy lost in this case)
        // The formula can be found here: https://en.wikipedia.org/wiki/Elastic_collision
        var adjustment = direction.mult(ballA.velocity.sub(ballB.velocity).dot(direction) / (distance * distance));
        ballA.velocity = Person.applySpeed(ballA.velocity.sub(adjustment));
        ballB.velocity = Person.applySpeed(ballB.velocity.sub(adjustment.negate()));
    };
    Person.borderCollision = function (border, ball) {
        if (!border.closed) {
            return;
        }
        if (border.ballLeftPosition <= ball.position.x && border.ballRightPosition >= ball.position.x) {
            // move ball outside the border
            ball.position.x = (ball.position.x <= border.position) ?
                border.ballLeftPosition : border.ballRightPosition;
            // reflect ball
            ball.velocity.x = -ball.velocity.x;
        }
    };
    Person.prototype.canvasBoundariesCollision = function () {
        if (this.position.x <= Person.LEFT_BOUNDARY || this.position.x >= Person.RIGHT_BOUNDARY) {
            // move ball inside the boundaries
            this.position.x = (this.position.x <= Person.LEFT_BOUNDARY) ?
                Person.LEFT_BOUNDARY : Person.RIGHT_BOUNDARY;
            // reflection ball
            this.velocity.x = -this.velocity.x;
        }
        if (this.position.y <= Person.TOP_BOUNDARY || this.position.y >= Person.BOTTOM_BOUNDARY) {
            // move ball inside the borders
            this.position.y = (this.position.y <= Person.TOP_BOUNDARY) ?
                Person.TOP_BOUNDARY : Person.BOTTOM_BOUNDARY;
            // reflection ball
            this.velocity.y = -this.velocity.y;
        }
    };
    Person.prototype.bordersCollision = function (leftBorder, rightBorder) {
        Person.borderCollision(leftBorder, this);
        Person.borderCollision(rightBorder, this);
    };
    Person.prototype.ballsCollision = function (ball, infectionRate) {
        if (this.health === Health.DEAD || ball.health === Health.DEAD) {
            return;
        }
        this.positionDiff.set(this.position);
        this.positionDiff.sub(ball.position);
        var distance = this.positionDiff.length();
        var distanceDiff = (2 * PERSON_RADIUS) - distance; // 2* ballradius === minDistance
        if (distanceDiff >= 0) {
            if (this.socialDistancing) {
                Person.reflectBall(ball, this.positionDiff.negate(), distanceDiff);
            }
            else if (ball.socialDistancing) {
                Person.reflectBall(this, this.positionDiff, distanceDiff);
            }
            else {
                Person.separateBalls(this, ball, this.positionDiff, distanceDiff);
                if (!ball.socialDistancing || !this.socialDistancing) {
                    Person.ellasticCollision(this, ball, this.positionDiff, distance);
                }
            }
            if ((this.health === Health.SICK || ball.health === Health.SICK) &&
                (this.health === Health.HEALTHY || ball.health === Health.HEALTHY) &&
                (this.rng() < infectionRate)) {
                this.health = ball.health = Health.SICK;
            } // both will be sick if at least one is infected in the collision
        }
    };
    Person.prototype.move = function () {
        if (!this.socialDistancing && this.health !== Health.DEAD) 
        // move the ball using velocities if not social distancing or dead
        {
            this.position = this.position.add(this.velocity);
        }
    };
    Person.prototype.checkHealth = function (deathRate) {
        if (this.health === Health.SICK && (--this.timeToRecovery) === 0) 
        // check if this ball is dead or recovered
        {
            this.health = (this.rng() < deathRate) ? Health.DEAD : Health.RECOVERED;
        }
    };
    Person.LEFT_BOUNDARY = PERSON_RADIUS;
    Person.RIGHT_BOUNDARY = WIDTH - PERSON_RADIUS;
    Person.TOP_BOUNDARY = PERSON_RADIUS;
    Person.BOTTOM_BOUNDARY = HEIGHT - PERSON_RADIUS;
    return Person;
}());
export { Person };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc29uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vcGFuZGVtaWMtc2ltdWxhdG9yLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9tb2RlbHMvcGVyc29uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUV0QztJQWlCRSxnQkFBbUIsTUFBYyxFQUFFLHFCQUFvQztRQUFwRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSHpCLGlCQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBSXhDLElBQUksQ0FBQyxHQUFHLEdBQUcscUJBQXFCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUM5QixnQkFBZ0IsQ0FBQyxJQUFJ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TUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1NBQ3pFO0lBQ0gsQ0FBQztJQS9JZSxvQkFBYSxHQUFHLGFBQWEsQ0FBQztJQUM5QixxQkFBYyxHQUFHLEtBQUssR0FBRyxhQUFhLENBQUM7SUFDdkMsbUJBQVksR0FBRyxhQUFhLENBQUM7SUFDN0Isc0JBQWUsR0FBRyxNQUFNLEdBQUcsYUFBYSxDQUFDO0lBNkkzRCxhQUFDO0NBQUEsQUFsSkQsSUFrSkM7U0FsSlksTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJvcmRlciB9IGZyb20gJy4vYm9yZGVyJztcbmltcG9ydCB7IEhFSUdIVCwgUEVSU09OX0dBUCwgUEVSU09OX1JBRElVUywgUEVSU09OX1NQRUVELCBzaWNrbmVzc0ludGVydmFsLCBXSURUSCB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IEhlYWx0aCB9IGZyb20gJy4vaGVhbHRoLmVudW0nO1xuaW1wb3J0IHsgVmVjdG9yMkQgfSBmcm9tICcuL3ZlY3RvcjJkJztcblxuZXhwb3J0IGNsYXNzIFBlcnNvbiB7XG5cbiAgc3RhdGljIHJlYWRvbmx5IExFRlRfQk9VTkRBUlkgPSBQRVJTT05fUkFESVVTO1xuICBzdGF0aWMgcmVhZG9ubHkgUklHSFRfQk9VTkRBUlkgPSBXSURUSCAtIFBFUlNPTl9SQURJVVM7XG4gIHN0YXRpYyByZWFkb25seSBUT1BfQk9VTkRBUlkgPSBQRVJTT05fUkFESVVTO1xuICBzdGF0aWMgcmVhZG9ubHkgQk9UVE9NX0JPVU5EQVJZID0gSEVJR0hUIC0gUEVSU09OX1JBRElVUztcblxuICBwb3NpdGlvbjogVmVjdG9yMkQ7XG4gIHNvY2lhbERpc3RhbmNpbmc6IGJvb2xlYW47XG5cblxuICBwcml2YXRlIHZlbG9jaXR5OiBWZWN0b3IyRDtcbiAgcHJpdmF0ZSB0aW1lVG9SZWNvdmVyeTogbnVtYmVyO1xuXG4gIHByaXZhdGUgcG9zaXRpb25EaWZmID0gbmV3IFZlY3RvcjJEKDAsIDApO1xuICBwcml2YXRlIHJuZzogKCkgPT4gbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBoZWFsdGg6IEhlYWx0aCwgcmFuZG9tTnVtYmVyR2VuZXJhdG9yPzogKCkgPT4gbnVtYmVyKSB7XG4gICAgdGhpcy5ybmcgPSByYW5kb21OdW1iZXJHZW5lcmF0b3IgfHwgTWF0aC5yYW5kb207XG4gICAgdGhpcy5wb3NpdGlvbiA9IFZlY3RvcjJELnJhbmRvbSh0aGlzLnJuZyk7XG4gICAgdGhpcy5wb3NpdGlvbi54ICo9IFdJRFRIO1xuICAgIHRoaXMucG9zaXRpb24ueSAqPSBIRUlHSFQ7XG4gICAgdGhpcy52ZWxvY2l0eSA9IFBlcnNvbi5hcHBseVNwZWVkKFZlY3RvcjJELnJhbmRvbSh0aGlzLnJuZykuc3ViKG5ldyBWZWN0b3IyRCgwLjUsIDAuNSkpKTtcbiAgICB0aGlzLnNvY2lhbERpc3RhbmNpbmcgPSBmYWxzZTtcbiAgICB0aGlzLnRpbWVUb1JlY292ZXJ5ID0gTWF0aC5mbG9vcihcbiAgICAgIHNpY2tuZXNzSW50ZXJ2YWwuZnJvbSArIHRoaXMucm5nKCkgKiAoc2lja25lc3NJbnRlcnZhbC50byAtIHNpY2tuZXNzSW50ZXJ2YWwuZnJvbSlcbiAgICApO1xuICB9XG5cbiAgc3RhdGljIGFwcGx5U3BlZWQodmVsb2NpdHk6IFZlY3RvcjJEKTogVmVjdG9yMkQge1xuICAgIHJldHVybiB2ZWxvY2l0eS5ub3JtYWxpemUoKS5tdWx0KFBFUlNPTl9TUEVFRCk7XG4gIH1cblxuICBzdGF0aWMgcmVmbGVjdEJhbGwoYmFsbDogUGVyc29uLCBkaXJlY3Rpb246IFZlY3RvcjJELCBkaXN0YW5jZURpZmY6IG51bWJlcik6IHZvaWQge1xuICAgIGRpcmVjdGlvbi5ub3JtYWxpemUoKTtcblxuICAgIC8vIG1vdmUgdGhlIGJhbGwgb3V0c2lkZSBvZiBjb2xsaXNpb25cbiAgICBjb25zdCBkaWZmID0gZGlzdGFuY2VEaWZmICsgUEVSU09OX0dBUCAvIDI7XG4gICAgYmFsbC5wb3NpdGlvbiA9IGJhbGwucG9zaXRpb24uYWRkKGRpcmVjdGlvbi5tdWx0KGRpZmYpKTtcblxuICAgIGRpcmVjdGlvbi5ub3JtYWxpemUoKTtcbiAgICAvLyByZWZsZWN0IGJhbGwsIHNvbHV0aW9uOiByPWTiiJIyKGQqbiluIChodHRwczovL21hdGguc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzEzMjYxL2hvdy10by1nZXQtYS1yZWZsZWN0aW9uLXZlY3RvcilcbiAgICBiYWxsLnZlbG9jaXR5ID0gYmFsbC52ZWxvY2l0eS5zdWIoZGlyZWN0aW9uLm11bHQoMiAqIGJhbGwudmVsb2NpdHkuZG90KGRpcmVjdGlvbikpKTtcbiAgfVxuXG4gIHN0YXRpYyBzZXBhcmF0ZUJhbGxzKGJhbGxBOiBQZXJzb24sIGJhbGxCOiBQZXJzb24sIHBvc2l0aW9uU3ViOiBWZWN0b3IyRCwgZGlzdGFuY2VEaWZmOiBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyBtb3ZlIGJhbGxzIG91dHNpZGUgb2YgY29sbGlzaW9uXG4gICAgY29uc3QgZGlmZiA9IGRpc3RhbmNlRGlmZiAvIDIgKyBQRVJTT05fR0FQO1xuICAgIGNvbnN0IGFkanVzdG1lbnQgPSBwb3NpdGlvblN1Yi5ub3JtYWxpemUoKS5tdWx0KGRpZmYpO1xuICAgIGJhbGxBLnBvc2l0aW9uID0gYmFsbEEucG9zaXRpb24uYWRkKGFkanVzdG1lbnQpO1xuICAgIGJhbGxCLnBvc2l0aW9uID0gYmFsbEIucG9zaXRpb24uYWRkKGFkanVzdG1lbnQubmVnYXRlKCkpO1xuICAgIHBvc2l0aW9uU3ViLm5vcm1hbGl6ZSgpO1xuICB9XG5cbiAgc3RhdGljIGVsbGFzdGljQ29sbGlzaW9uKGJhbGxBOiBQZXJzb24sIGJhbGxCOiBQZXJzb24sIGRpcmVjdGlvbjogVmVjdG9yMkQsIGRpc3RhbmNlOiBudW1iZXIpOiB2b2lkIHtcbiAgICAvLyBFbGFzdGljIGNvbGxpc2lvbiwgYnV0IHRoZSBiYWxsIHNwZWVkIGlzIHJldmVydGVkIGFmdGVyIHRoZSBjb2xsaXNpb24gKG5vIGVuZXJneSBsb3N0IGluIHRoaXMgY2FzZSlcbiAgICAvLyBUaGUgZm9ybXVsYSBjYW4gYmUgZm91bmQgaGVyZTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRWxhc3RpY19jb2xsaXNpb25cbiAgICBjb25zdCBhZGp1c3RtZW50ID0gZGlyZWN0aW9uLm11bHQoYmFsbEEudmVsb2NpdHkuc3ViKGJhbGxCLnZlbG9jaXR5KS5kb3QoZGlyZWN0aW9uKSAvIChkaXN0YW5jZSAqIGRpc3RhbmNlKSk7XG4gICAgYmFsbEEudmVsb2NpdHkgPSBQZXJzb24uYXBwbHlTcGVlZChiYWxsQS52ZWxvY2l0eS5zdWIoYWRqdXN0bWVudCkpO1xuICAgIGJhbGxCLnZlbG9jaXR5ID0gUGVyc29uLmFwcGx5U3BlZWQoYmFsbEIudmVsb2NpdHkuc3ViKGFkanVzdG1lbnQubmVnYXRlKCkpKTtcbiAgfVxuXG4gIHN0YXRpYyBib3JkZXJDb2xsaXNpb24oYm9yZGVyOiBCb3JkZXIsIGJhbGw6IFBlcnNvbik6IHZvaWQge1xuICAgIGlmICghYm9yZGVyLmNsb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChib3JkZXIuYmFsbExlZnRQb3NpdGlvbiA8PSBiYWxsLnBvc2l0aW9uLnggJiYgYm9yZGVyLmJhbGxSaWdodFBvc2l0aW9uID49IGJhbGwucG9zaXRpb24ueCkge1xuICAgICAgLy8gbW92ZSBiYWxsIG91dHNpZGUgdGhlIGJvcmRlclxuICAgICAgYmFsbC5wb3NpdGlvbi54ID0gKGJhbGwucG9zaXRpb24ueCA8PSBib3JkZXIucG9zaXRpb24pID9cbiAgICAgICAgYm9yZGVyLmJhbGxMZWZ0UG9zaXRpb24gOiBib3JkZXIuYmFsbFJpZ2h0UG9zaXRpb247XG5cbiAgICAgIC8vIHJlZmxlY3QgYmFsbFxuICAgICAgYmFsbC52ZWxvY2l0eS54ID0gLWJhbGwudmVsb2NpdHkueDtcbiAgICB9XG4gIH1cblxuICBjYW52YXNCb3VuZGFyaWVzQ29sbGlzaW9uKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnBvc2l0aW9uLnggPD0gUGVyc29uLkxFRlRfQk9VTkRBUlkgfHwgdGhpcy5wb3NpdGlvbi54ID49IFBlcnNvbi5SSUdIVF9CT1VOREFSWSkge1xuICAgICAgLy8gbW92ZSBiYWxsIGluc2lkZSB0aGUgYm91bmRhcmllc1xuICAgICAgdGhpcy5wb3NpdGlvbi54ID0gKHRoaXMucG9zaXRpb24ueCA8PSBQZXJzb24uTEVGVF9CT1VOREFSWSkgP1xuICAgICAgICBQZXJzb24uTEVGVF9CT1VOREFSWSA6IFBlcnNvbi5SSUdIVF9CT1VOREFSWTtcblxuICAgICAgLy8gcmVmbGVjdGlvbiBiYWxsXG4gICAgICB0aGlzLnZlbG9jaXR5LnggPSAtdGhpcy52ZWxvY2l0eS54O1xuICAgIH1cbiAgICBpZiAodGhpcy5wb3NpdGlvbi55IDw9IFBlcnNvbi5UT1BfQk9VTkRBUlkgfHwgdGhpcy5wb3NpdGlvbi55ID49IFBlcnNvbi5CT1RUT01fQk9VTkRBUlkpIHtcbiAgICAgIC8vIG1vdmUgYmFsbCBpbnNpZGUgdGhlIGJvcmRlcnNcbiAgICAgIHRoaXMucG9zaXRpb24ueSA9ICh0aGlzLnBvc2l0aW9uLnkgPD0gUGVyc29uLlRPUF9CT1VOREFSWSkgP1xuICAgICAgICBQZXJzb24uVE9QX0JPVU5EQVJZIDogUGVyc29uLkJPVFRPTV9CT1VOREFSWTtcblxuICAgICAgLy8gcmVmbGVjdGlvbiBiYWxsXG4gICAgICB0aGlzLnZlbG9jaXR5LnkgPSAtdGhpcy52ZWxvY2l0eS55O1xuICAgIH1cbiAgfVxuXG4gIGJvcmRlcnNDb2xsaXNpb24obGVmdEJvcmRlcjogQm9yZGVyLCByaWdodEJvcmRlcjogQm9yZGVyKTogdm9pZCB7XG4gICAgUGVyc29uLmJvcmRlckNvbGxpc2lvbihsZWZ0Qm9yZGVyLCB0aGlzKTtcbiAgICBQZXJzb24uYm9yZGVyQ29sbGlzaW9uKHJpZ2h0Qm9yZGVyLCB0aGlzKTtcbiAgfVxuXG4gIGJhbGxzQ29sbGlzaW9uKGJhbGw6IFBlcnNvbiwgaW5mZWN0aW9uUmF0ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaGVhbHRoID09PSBIZWFsdGguREVBRCB8fCBiYWxsLmhlYWx0aCA9PT0gSGVhbHRoLkRFQUQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5wb3NpdGlvbkRpZmYuc2V0KHRoaXMucG9zaXRpb24pO1xuICAgIHRoaXMucG9zaXRpb25EaWZmLnN1YihiYWxsLnBvc2l0aW9uKTtcbiAgICBjb25zdCBkaXN0YW5jZSA9IHRoaXMucG9zaXRpb25EaWZmLmxlbmd0aCgpO1xuICAgIGNvbnN0IGRpc3RhbmNlRGlmZiA9ICgyICogUEVSU09OX1JBRElVUykgLSBkaXN0YW5jZTsgLy8gMiogYmFsbHJhZGl1cyA9PT0gbWluRGlzdGFuY2VcblxuICAgIGlmIChkaXN0YW5jZURpZmYgPj0gMCkge1xuICAgICAgaWYgKHRoaXMuc29jaWFsRGlzdGFuY2luZykge1xuICAgICAgICBQZXJzb24ucmVmbGVjdEJhbGwoYmFsbCwgdGhpcy5wb3NpdGlvbkRpZmYubmVnYXRlKCksIGRpc3RhbmNlRGlmZik7XG4gICAgICB9IGVsc2UgaWYgKGJhbGwuc29jaWFsRGlzdGFuY2luZykge1xuICAgICAgICBQZXJzb24ucmVmbGVjdEJhbGwodGhpcywgdGhpcy5wb3NpdGlvbkRpZmYsIGRpc3RhbmNlRGlmZik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBQZXJzb24uc2VwYXJhdGVCYWxscyh0aGlzLCBiYWxsLCB0aGlzLnBvc2l0aW9uRGlmZiwgZGlzdGFuY2VEaWZmKTtcblxuICAgICAgICBpZiAoIWJhbGwuc29jaWFsRGlzdGFuY2luZyB8fCAhdGhpcy5zb2NpYWxEaXN0YW5jaW5nKSB7XG4gICAgICAgICAgUGVyc29uLmVsbGFzdGljQ29sbGlzaW9uKHRoaXMsIGJhbGwsIHRoaXMucG9zaXRpb25EaWZmLCBkaXN0YW5jZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKCh0aGlzLmhlYWx0aCA9PT0gSGVhbHRoLlNJQ0sgfHwgYmFsbC5oZWFsdGggPT09IEhlYWx0aC5TSUNLKSAmJlxuICAgICAgICAodGhpcy5oZWFsdGggPT09IEhlYWx0aC5IRUFMVEhZIHx8IGJhbGwuaGVhbHRoID09PSBIZWFsdGguSEVBTFRIWSkgJiZcbiAgICAgICAgKHRoaXMucm5nKCkgPCBpbmZlY3Rpb25SYXRlKSkge1xuICAgICAgICB0aGlzLmhlYWx0aCA9IGJhbGwuaGVhbHRoID0gSGVhbHRoLlNJQ0s7XG4gICAgICB9ICAgLy8gYm90aCB3aWxsIGJlIHNpY2sgaWYgYXQgbGVhc3Qgb25lIGlzIGluZmVjdGVkIGluIHRoZSBjb2xsaXNpb25cbiAgICB9XG4gIH1cblxuICBtb3ZlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5zb2NpYWxEaXN0YW5jaW5nICYmIHRoaXMuaGVhbHRoICE9PSBIZWFsdGguREVBRClcbiAgICAgIC8vIG1vdmUgdGhlIGJhbGwgdXNpbmcgdmVsb2NpdGllcyBpZiBub3Qgc29jaWFsIGRpc3RhbmNpbmcgb3IgZGVhZFxuICAgIHtcbiAgICAgIHRoaXMucG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uLmFkZCh0aGlzLnZlbG9jaXR5KTtcbiAgICB9XG4gIH1cblxuICBjaGVja0hlYWx0aChkZWF0aFJhdGU6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYWx0aCA9PT0gSGVhbHRoLlNJQ0sgJiYgKC0tdGhpcy50aW1lVG9SZWNvdmVyeSkgPT09IDApXG4gICAgICAvLyBjaGVjayBpZiB0aGlzIGJhbGwgaXMgZGVhZCBvciByZWNvdmVyZWRcbiAgICB7XG4gICAgICB0aGlzLmhlYWx0aCA9ICh0aGlzLnJuZygpIDwgZGVhdGhSYXRlKSA/IEhlYWx0aC5ERUFEIDogSGVhbHRoLlJFQ09WRVJFRDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==