import { HEIGHT, PERSON_GAP, PERSON_RADIUS, PERSON_SPEED, sicknessInterval, WIDTH } from './constants';
import { Health } from './health.enum';
import { Vector2D } from './vector2d';
export class Person {
    constructor(health, randomNumberGenerator) {
        this.health = health;
        this.positionDiff = new Vector2D(0, 0);
        this.rng = randomNumberGenerator || Math.random;
        this.position = Vector2D.random(this.rng);
        this.position.x *= WIDTH;
        this.position.y *= HEIGHT;
        this.velocity = Person.applySpeed(Vector2D.random(this.rng).sub(new Vector2D(0.5, 0.5)));
        this.socialDistancing = false;
        this.timeToRecovery = Math.floor(sicknessInterval.from + this.rng() * (sicknessInterval.to - sicknessInterval.from));
    }
    static applySpeed(velocity) {
        return velocity.normalize().mult(PERSON_SPEED);
    }
    static reflectBall(ball, direction, distanceDiff) {
        direction.normalize();
        // move the ball outside of collision
        const diff = distanceDiff + PERSON_GAP / 2;
        ball.position = ball.position.add(direction.mult(diff));
        direction.normalize();
        // reflect ball, solution: r=dâˆ’2(d*n)n (https://math.stackexchange.com/questions/13261/how-to-get-a-reflection-vector)
        ball.velocity = ball.velocity.sub(direction.mult(2 * ball.velocity.dot(direction)));
    }
    static separateBalls(ballA, ballB, positionSub, distanceDiff) {
        // move balls outside of collision
        const diff = distanceDiff / 2 + PERSON_GAP;
        const adjustment = positionSub.normalize().mult(diff);
        ballA.position = ballA.position.add(adjustment);
        ballB.position = ballB.position.add(adjustment.negate());
        positionSub.normalize();
    }
    static ellasticCollision(ballA, ballB, direction, distance) {
        // Elastic collision, but the ball speed is reverted after the collision (no energy lost in this case)
        // The formula can be found here: https://en.wikipedia.org/wiki/Elastic_collision
        const adjustment = direction.mult(ballA.velocity.sub(ballB.velocity).dot(direction) / (distance * distance));
        ballA.velocity = Person.applySpeed(ballA.velocity.sub(adjustment));
        ballB.velocity = Person.applySpeed(ballB.velocity.sub(adjustment.negate()));
    }
    static borderCollision(border, ball) {
        if (!border.closed) {
            return;
        }
        if (border.ballLeftPosition <= ball.position.x && border.ballRightPosition >= ball.position.x) {
            // move ball outside the border
            ball.position.x = (ball.position.x <= border.position) ?
                border.ballLeftPosition : border.ballRightPosition;
            // reflect ball
            ball.velocity.x = -ball.velocity.x;
        }
    }
    canvasBoundariesCollision() {
        if (this.position.x <= Person.LEFT_BOUNDARY || this.position.x >= Person.RIGHT_BOUNDARY) {
            // move ball inside the boundaries
            this.position.x = (this.position.x <= Person.LEFT_BOUNDARY) ?
                Person.LEFT_BOUNDARY : Person.RIGHT_BOUNDARY;
            // reflection ball
            this.velocity.x = -this.velocity.x;
        }
        if (this.position.y <= Person.TOP_BOUNDARY || this.position.y >= Person.BOTTOM_BOUNDARY) {
            // move ball inside the borders
            this.position.y = (this.position.y <= Person.TOP_BOUNDARY) ?
                Person.TOP_BOUNDARY : Person.BOTTOM_BOUNDARY;
            // reflection ball
            this.velocity.y = -this.velocity.y;
        }
    }
    bordersCollision(leftBorder, rightBorder) {
        Person.borderCollision(leftBorder, this);
        Person.borderCollision(rightBorder, this);
    }
    ballsCollision(ball, infectionRate) {
        if (this.health === Health.DEAD || ball.health === Health.DEAD) {
            return;
        }
        this.positionDiff.set(this.position);
        this.positionDiff.sub(ball.position);
        const distance = this.positionDiff.length();
        const distanceDiff = (2 * PERSON_RADIUS) - distance; // 2* ballradius === minDistance
        if (distanceDiff >= 0) {
            if (this.socialDistancing) {
                Person.reflectBall(ball, this.positionDiff.negate(), distanceDiff);
            }
            else if (ball.socialDistancing) {
                Person.reflectBall(this, this.positionDiff, distanceDiff);
            }
            else {
                Person.separateBalls(this, ball, this.positionDiff, distanceDiff);
                if (!ball.socialDistancing || !this.socialDistancing) {
                    Person.ellasticCollision(this, ball, this.positionDiff, distance);
                }
            }
            if ((this.health === Health.SICK || ball.health === Health.SICK) &&
                (this.health === Health.HEALTHY || ball.health === Health.HEALTHY) &&
                (this.rng() < infectionRate)) {
                this.health = ball.health = Health.SICK;
            } // both will be sick if at least one is infected in the collision
        }
    }
    move() {
        if (!this.socialDistancing && this.health !== Health.DEAD) 
        // move the ball using velocities if not social distancing or dead
        {
            this.position = this.position.add(this.velocity);
        }
    }
    checkHealth(deathRate) {
        if (this.health === Health.SICK && (--this.timeToRecovery) === 0) 
        // check if this ball is dead or recovered
        {
            this.health = (this.rng() < deathRate) ? Health.DEAD : Health.RECOVERED;
        }
    }
}
Person.LEFT_BOUNDARY = PERSON_RADIUS;
Person.RIGHT_BOUNDARY = WIDTH - PERSON_RADIUS;
Person.TOP_BOUNDARY = PERSON_RADIUS;
Person.BOTTOM_BOUNDARY = HEIGHT - PERSON_RADIUS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc29uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvcGFuZGVtaWMtc2ltdWxhdG9yLWxpYi9zcmMvbGliL21vZGVscy9wZXJzb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2QyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRXRDLE1BQU0sT0FBTyxNQUFNO0lBaUJqQixZQUFtQixNQUFjLEVBQUUscUJBQW9DO1FBQXBELFdBQU0sR0FBTixNQUFNLENBQVE7UUFIekIsaUJBQVksR0FBRyxJQUFJLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFJeEMsSUFBSSxDQUFDLEdBQUcsR0FBRyxxQkFBcUIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDO1FBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQztRQUMxQixJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekYsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUM5QixJQUFJLENBQUMsY0FBYyxHQUFH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QzVDO1lBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQztTQUN6RTtJQUNILENBQUM7O0FBL0llLG9CQUFhLEdBQUcsYUFBYSxDQUFDO0FBQzlCLHFCQUFjLEdBQUcsS0FBSyxHQUFHLGFBQWEsQ0FBQztBQUN2QyxtQkFBWSxHQUFHLGFBQWEsQ0FBQztBQUM3QixzQkFBZSxHQUFHLE1BQU0sR0FBRyxhQUFhLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb3JkZXIgfSBmcm9tICcuL2JvcmRlcic7XG5pbXBvcnQgeyBIRUlHSFQsIFBFUlNPTl9HQVAsIFBFUlNPTl9SQURJVVMsIFBFUlNPTl9TUEVFRCwgc2lja25lc3NJbnRlcnZhbCwgV0lEVEggfSBmcm9tICcuL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBIZWFsdGggfSBmcm9tICcuL2hlYWx0aC5lbnVtJztcbmltcG9ydCB7IFZlY3RvcjJEIH0gZnJvbSAnLi92ZWN0b3IyZCc7XG5cbmV4cG9ydCBjbGFzcyBQZXJzb24ge1xuXG4gIHN0YXRpYyByZWFkb25seSBMRUZUX0JPVU5EQVJZID0gUEVSU09OX1JBRElVUztcbiAgc3RhdGljIHJlYWRvbmx5IFJJR0hUX0JPVU5EQVJZID0gV0lEVEggLSBQRVJTT05fUkFESVVTO1xuICBzdGF0aWMgcmVhZG9ubHkgVE9QX0JPVU5EQVJZID0gUEVSU09OX1JBRElVUztcbiAgc3RhdGljIHJlYWRvbmx5IEJPVFRPTV9CT1VOREFSWSA9IEhFSUdIVCAtIFBFUlNPTl9SQURJVVM7XG5cbiAgcG9zaXRpb246IFZlY3RvcjJEO1xuICBzb2NpYWxEaXN0YW5jaW5nOiBib29sZWFuO1xuXG5cbiAgcHJpdmF0ZSB2ZWxvY2l0eTogVmVjdG9yMkQ7XG4gIHByaXZhdGUgdGltZVRvUmVjb3Zlcnk6IG51bWJlcjtcblxuICBwcml2YXRlIHBvc2l0aW9uRGlmZiA9IG5ldyBWZWN0b3IyRCgwLCAwKTtcbiAgcHJpdmF0ZSBybmc6ICgpID0+IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgaGVhbHRoOiBIZWFsdGgsIHJhbmRvbU51bWJlckdlbmVyYXRvcj86ICgpID0+IG51bWJlcikge1xuICAgIHRoaXMucm5nID0gcmFuZG9tTnVtYmVyR2VuZXJhdG9yIHx8IE1hdGgucmFuZG9tO1xuICAgIHRoaXMucG9zaXRpb24gPSBWZWN0b3IyRC5yYW5kb20odGhpcy5ybmcpO1xuICAgIHRoaXMucG9zaXRpb24ueCAqPSBXSURUSDtcbiAgICB0aGlzLnBvc2l0aW9uLnkgKj0gSEVJR0hUO1xuICAgIHRoaXMudmVsb2NpdHkgPSBQZXJzb24uYXBwbHlTcGVlZChWZWN0b3IyRC5yYW5kb20odGhpcy5ybmcpLnN1YihuZXcgVmVjdG9yMkQoMC41LCAwLjUpKSk7XG4gICAgdGhpcy5zb2NpYWxEaXN0YW5jaW5nID0gZmFsc2U7XG4gICAgdGhpcy50aW1lVG9SZWNvdmVyeSA9IE1hdGguZmxvb3IoXG4gICAgICBzaWNrbmVzc0ludGVydmFsLmZyb20gKyB0aGlzLnJuZygpICogKHNpY2tuZXNzSW50ZXJ2YWwudG8gLSBzaWNrbmVzc0ludGVydmFsLmZyb20pXG4gICAgKTtcbiAgfVxuXG4gIHN0YXRpYyBhcHBseVNwZWVkKHZlbG9jaXR5OiBWZWN0b3IyRCk6IFZlY3RvcjJEIHtcbiAgICByZXR1cm4gdmVsb2NpdHkubm9ybWFsaXplKCkubXVsdChQRVJTT05fU1BFRUQpO1xuICB9XG5cbiAgc3RhdGljIHJlZmxlY3RCYWxsKGJhbGw6IFBlcnNvbiwgZGlyZWN0aW9uOiBWZWN0b3IyRCwgZGlzdGFuY2VEaWZmOiBudW1iZXIpOiB2b2lkIHtcbiAgICBkaXJlY3Rpb24ubm9ybWFsaXplKCk7XG5cbiAgICAvLyBtb3ZlIHRoZSBiYWxsIG91dHNpZGUgb2YgY29sbGlzaW9uXG4gICAgY29uc3QgZGlmZiA9IGRpc3RhbmNlRGlmZiArIFBFUlNPTl9HQVAgLyAyO1xuICAgIGJhbGwucG9zaXRpb24gPSBiYWxsLnBvc2l0aW9uLmFkZChkaXJlY3Rpb24ubXVsdChkaWZmKSk7XG5cbiAgICBkaXJlY3Rpb24ubm9ybWFsaXplKCk7XG4gICAgLy8gcmVmbGVjdCBiYWxsLCBzb2x1dGlvbjogcj1k4oiSMihkKm4pbiAoaHR0cHM6Ly9tYXRoLnN0YWNrZXhjaGFuZ2UuY29tL3F1ZXN0aW9ucy8xMzI2MS9ob3ctdG8tZ2V0LWEtcmVmbGVjdGlvbi12ZWN0b3IpXG4gICAgYmFsbC52ZWxvY2l0eSA9IGJhbGwudmVsb2NpdHkuc3ViKGRpcmVjdGlvbi5tdWx0KDIgKiBiYWxsLnZlbG9jaXR5LmRvdChkaXJlY3Rpb24pKSk7XG4gIH1cblxuICBzdGF0aWMgc2VwYXJhdGVCYWxscyhiYWxsQTogUGVyc29uLCBiYWxsQjogUGVyc29uLCBwb3NpdGlvblN1YjogVmVjdG9yMkQsIGRpc3RhbmNlRGlmZjogbnVtYmVyKTogdm9pZCB7XG4gICAgLy8gbW92ZSBiYWxscyBvdXRzaWRlIG9mIGNvbGxpc2lvblxuICAgIGNvbnN0IGRpZmYgPSBkaXN0YW5jZURpZmYgLyAyICsgUEVSU09OX0dBUDtcbiAgICBjb25zdCBhZGp1c3RtZW50ID0gcG9zaXRpb25TdWIubm9ybWFsaXplKCkubXVsdChkaWZmKTtcbiAgICBiYWxsQS5wb3NpdGlvbiA9IGJhbGxBLnBvc2l0aW9uLmFkZChhZGp1c3RtZW50KTtcbiAgICBiYWxsQi5wb3NpdGlvbiA9IGJhbGxCLnBvc2l0aW9uLmFkZChhZGp1c3RtZW50Lm5lZ2F0ZSgpKTtcbiAgICBwb3NpdGlvblN1Yi5ub3JtYWxpemUoKTtcbiAgfVxuXG4gIHN0YXRpYyBlbGxhc3RpY0NvbGxpc2lvbihiYWxsQTogUGVyc29uLCBiYWxsQjogUGVyc29uLCBkaXJlY3Rpb246IFZlY3RvcjJELCBkaXN0YW5jZTogbnVtYmVyKTogdm9pZCB7XG4gICAgLy8gRWxhc3RpYyBjb2xsaXNpb24sIGJ1dCB0aGUgYmFsbCBzcGVlZCBpcyByZXZlcnRlZCBhZnRlciB0aGUgY29sbGlzaW9uIChubyBlbmVyZ3kgbG9zdCBpbiB0aGlzIGNhc2UpXG4gICAgLy8gVGhlIGZvcm11bGEgY2FuIGJlIGZvdW5kIGhlcmU6IGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0VsYXN0aWNfY29sbGlzaW9uXG4gICAgY29uc3QgYWRqdXN0bWVudCA9IGRpcmVjdGlvbi5tdWx0KGJhbGxBLnZlbG9jaXR5LnN1YihiYWxsQi52ZWxvY2l0eSkuZG90KGRpcmVjdGlvbikgLyAoZGlzdGFuY2UgKiBkaXN0YW5jZSkpO1xuICAgIGJhbGxBLnZlbG9jaXR5ID0gUGVyc29uLmFwcGx5U3BlZWQoYmFsbEEudmVsb2NpdHkuc3ViKGFkanVzdG1lbnQpKTtcbiAgICBiYWxsQi52ZWxvY2l0eSA9IFBlcnNvbi5hcHBseVNwZWVkKGJhbGxCLnZlbG9jaXR5LnN1YihhZGp1c3RtZW50Lm5lZ2F0ZSgpKSk7XG4gIH1cblxuICBzdGF0aWMgYm9yZGVyQ29sbGlzaW9uKGJvcmRlcjogQm9yZGVyLCBiYWxsOiBQZXJzb24pOiB2b2lkIHtcbiAgICBpZiAoIWJvcmRlci5jbG9zZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoYm9yZGVyLmJhbGxMZWZ0UG9zaXRpb24gPD0gYmFsbC5wb3NpdGlvbi54ICYmIGJvcmRlci5iYWxsUmlnaHRQb3NpdGlvbiA+PSBiYWxsLnBvc2l0aW9uLngpIHtcbiAgICAgIC8vIG1vdmUgYmFsbCBvdXRzaWRlIHRoZSBib3JkZXJcbiAgICAgIGJhbGwucG9zaXRpb24ueCA9IChiYWxsLnBvc2l0aW9uLnggPD0gYm9yZGVyLnBvc2l0aW9uKSA/XG4gICAgICAgIGJvcmRlci5iYWxsTGVmdFBvc2l0aW9uIDogYm9yZGVyLmJhbGxSaWdodFBvc2l0aW9uO1xuXG4gICAgICAvLyByZWZsZWN0IGJhbGxcbiAgICAgIGJhbGwudmVsb2NpdHkueCA9IC1iYWxsLnZlbG9jaXR5Lng7XG4gICAgfVxuICB9XG5cbiAgY2FudmFzQm91bmRhcmllc0NvbGxpc2lvbigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5wb3NpdGlvbi54IDw9IFBlcnNvbi5MRUZUX0JPVU5EQVJZIHx8IHRoaXMucG9zaXRpb24ueCA+PSBQZXJzb24uUklHSFRfQk9VTkRBUlkpIHtcbiAgICAgIC8vIG1vdmUgYmFsbCBpbnNpZGUgdGhlIGJvdW5kYXJpZXNcbiAgICAgIHRoaXMucG9zaXRpb24ueCA9ICh0aGlzLnBvc2l0aW9uLnggPD0gUGVyc29uLkxFRlRfQk9VTkRBUlkpID9cbiAgICAgICAgUGVyc29uLkxFRlRfQk9VTkRBUlkgOiBQZXJzb24uUklHSFRfQk9VTkRBUlk7XG5cbiAgICAgIC8vIHJlZmxlY3Rpb24gYmFsbFxuICAgICAgdGhpcy52ZWxvY2l0eS54ID0gLXRoaXMudmVsb2NpdHkueDtcbiAgICB9XG4gICAgaWYgKHRoaXMucG9zaXRpb24ueSA8PSBQZXJzb24uVE9QX0JPVU5EQVJZIHx8IHRoaXMucG9zaXRpb24ueSA+PSBQZXJzb24uQk9UVE9NX0JPVU5EQVJZKSB7XG4gICAgICAvLyBtb3ZlIGJhbGwgaW5zaWRlIHRoZSBib3JkZXJzXG4gICAgICB0aGlzLnBvc2l0aW9uLnkgPSAodGhpcy5wb3NpdGlvbi55IDw9IFBlcnNvbi5UT1BfQk9VTkRBUlkpID9cbiAgICAgICAgUGVyc29uLlRPUF9CT1VOREFSWSA6IFBlcnNvbi5CT1RUT01fQk9VTkRBUlk7XG5cbiAgICAgIC8vIHJlZmxlY3Rpb24gYmFsbFxuICAgICAgdGhpcy52ZWxvY2l0eS55ID0gLXRoaXMudmVsb2NpdHkueTtcbiAgICB9XG4gIH1cblxuICBib3JkZXJzQ29sbGlzaW9uKGxlZnRCb3JkZXI6IEJvcmRlciwgcmlnaHRCb3JkZXI6IEJvcmRlcik6IHZvaWQge1xuICAgIFBlcnNvbi5ib3JkZXJDb2xsaXNpb24obGVmdEJvcmRlciwgdGhpcyk7XG4gICAgUGVyc29uLmJvcmRlckNvbGxpc2lvbihyaWdodEJvcmRlciwgdGhpcyk7XG4gIH1cblxuICBiYWxsc0NvbGxpc2lvbihiYWxsOiBQZXJzb24sIGluZmVjdGlvblJhdGU6IG51bWJlcik6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYWx0aCA9PT0gSGVhbHRoLkRFQUQgfHwgYmFsbC5oZWFsdGggPT09IEhlYWx0aC5ERUFEKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucG9zaXRpb25EaWZmLnNldCh0aGlzLnBvc2l0aW9uKTtcbiAgICB0aGlzLnBvc2l0aW9uRGlmZi5zdWIoYmFsbC5wb3NpdGlvbik7XG4gICAgY29uc3QgZGlzdGFuY2UgPSB0aGlzLnBvc2l0aW9uRGlmZi5sZW5ndGgoKTtcbiAgICBjb25zdCBkaXN0YW5jZURpZmYgPSAoMiAqIFBFUlNPTl9SQURJVVMpIC0gZGlzdGFuY2U7IC8vIDIqIGJhbGxyYWRpdXMgPT09IG1pbkRpc3RhbmNlXG5cbiAgICBpZiAoZGlzdGFuY2VEaWZmID49IDApIHtcbiAgICAgIGlmICh0aGlzLnNvY2lhbERpc3RhbmNpbmcpIHtcbiAgICAgICAgUGVyc29uLnJlZmxlY3RCYWxsKGJhbGwsIHRoaXMucG9zaXRpb25EaWZmLm5lZ2F0ZSgpLCBkaXN0YW5jZURpZmYpO1xuICAgICAgfSBlbHNlIGlmIChiYWxsLnNvY2lhbERpc3RhbmNpbmcpIHtcbiAgICAgICAgUGVyc29uLnJlZmxlY3RCYWxsKHRoaXMsIHRoaXMucG9zaXRpb25EaWZmLCBkaXN0YW5jZURpZmYpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgUGVyc29uLnNlcGFyYXRlQmFsbHModGhpcywgYmFsbCwgdGhpcy5wb3NpdGlvbkRpZmYsIGRpc3RhbmNlRGlmZik7XG5cbiAgICAgICAgaWYgKCFiYWxsLnNvY2lhbERpc3RhbmNpbmcgfHwgIXRoaXMuc29jaWFsRGlzdGFuY2luZykge1xuICAgICAgICAgIFBlcnNvbi5lbGxhc3RpY0NvbGxpc2lvbih0aGlzLCBiYWxsLCB0aGlzLnBvc2l0aW9uRGlmZiwgZGlzdGFuY2UpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmICgodGhpcy5oZWFsdGggPT09IEhlYWx0aC5TSUNLIHx8IGJhbGwuaGVhbHRoID09PSBIZWFsdGguU0lDSykgJiZcbiAgICAgICAgKHRoaXMuaGVhbHRoID09PSBIZWFsdGguSEVBTFRIWSB8fCBiYWxsLmhlYWx0aCA9PT0gSGVhbHRoLkhFQUxUSFkpICYmXG4gICAgICAgICh0aGlzLnJuZygpIDwgaW5mZWN0aW9uUmF0ZSkpIHtcbiAgICAgICAgdGhpcy5oZWFsdGggPSBiYWxsLmhlYWx0aCA9IEhlYWx0aC5TSUNLO1xuICAgICAgfSAgIC8vIGJvdGggd2lsbCBiZSBzaWNrIGlmIGF0IGxlYXN0IG9uZSBpcyBpbmZlY3RlZCBpbiB0aGUgY29sbGlzaW9uXG4gICAgfVxuICB9XG5cbiAgbW92ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc29jaWFsRGlzdGFuY2luZyAmJiB0aGlzLmhlYWx0aCAhPT0gSGVhbHRoLkRFQUQpXG4gICAgICAvLyBtb3ZlIHRoZSBiYWxsIHVzaW5nIHZlbG9jaXRpZXMgaWYgbm90IHNvY2lhbCBkaXN0YW5jaW5nIG9yIGRlYWRcbiAgICB7XG4gICAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5wb3NpdGlvbi5hZGQodGhpcy52ZWxvY2l0eSk7XG4gICAgfVxuICB9XG5cbiAgY2hlY2tIZWFsdGgoZGVhdGhSYXRlOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5oZWFsdGggPT09IEhlYWx0aC5TSUNLICYmICgtLXRoaXMudGltZVRvUmVjb3ZlcnkpID09PSAwKVxuICAgICAgLy8gY2hlY2sgaWYgdGhpcyBiYWxsIGlzIGRlYWQgb3IgcmVjb3ZlcmVkXG4gICAge1xuICAgICAgdGhpcy5oZWFsdGggPSAodGhpcy5ybmcoKSA8IGRlYXRoUmF0ZSkgPyBIZWFsdGguREVBRCA6IEhlYWx0aC5SRUNPVkVSRUQ7XG4gICAgfVxuICB9XG59XG4iXX0=