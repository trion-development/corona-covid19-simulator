import { HEIGHT, PERSON_GAP, PERSON_RADIUS, PERSON_SPEED, sicknessInterval, WIDTH } from './constants';
import { Health } from './health.enum';
import { Vector2D } from './vector2d';
export class Person {
    constructor(health, randomNumberGenerator) {
        this.health = health;
        this.positionDiff = new Vector2D(0, 0);
        this.rng = randomNumberGenerator || Math.random;
        this.position = Vector2D.random(this.rng);
        this.position.x *= WIDTH;
        this.position.y *= HEIGHT;
        this.velocity = Person.applySpeed(Vector2D.random(this.rng).sub(new Vector2D(0.5, 0.5)));
        this.socialDistancing = false;
        this.timeToRecovery = Math.floor(sicknessInterval.from + this.rng() * (sicknessInterval.to - sicknessInterval.from));
    }
    static applySpeed(velocity) {
        return velocity.normalize().mult(PERSON_SPEED);
    }
    static reflectBall(ball, direction, distanceDiff) {
        direction.normalize();
        // move the ball outside of collision
        const diff = distanceDiff + PERSON_GAP / 2;
        ball.position = ball.position.add(direction.mult(diff));
        direction.normalize();
        // reflect ball, solution: r=dâˆ’2(d*n)n (https://math.stackexchange.com/questions/13261/how-to-get-a-reflection-vector)
        ball.velocity = ball.velocity.sub(direction.mult(2 * ball.velocity.dot(direction)));
    }
    static separateBalls(ballA, ballB, positionSub, distanceDiff) {
        // move balls outside of collision
        const diff = distanceDiff / 2 + PERSON_GAP;
        const adjustment = positionSub.normalize().mult(diff);
        ballA.position = ballA.position.add(adjustment);
        ballB.position = ballB.position.add(adjustment.negate());
        positionSub.normalize();
    }
    static ellasticCollision(ballA, ballB, direction, distance) {
        // Elastic collision, but the ball speed is reverted after the collision (no energy lost in this case)
        // The formula can be found here: https://en.wikipedia.org/wiki/Elastic_collision
        const adjustment = direction.mult(ballA.velocity.sub(ballB.velocity).dot(direction) / (distance * distance));
        ballA.velocity = Person.applySpeed(ballA.velocity.sub(adjustment));
        ballB.velocity = Person.applySpeed(ballB.velocity.sub(adjustment.negate()));
    }
    static borderCollision(border, ball) {
        if (!border.closed) {
            return;
        }
        if (border.ballLeftPosition <= ball.position.x && border.ballRightPosition >= ball.position.x) {
            // move ball outside the border
            ball.position.x = (ball.position.x <= border.position) ?
                border.ballLeftPosition : border.ballRightPosition;
            // reflect ball
            ball.velocity.x = -ball.velocity.x;
        }
    }
    canvasBoundariesCollision() {
        if (this.position.x <= Person.LEFT_BOUNDARY || this.position.x >= Person.RIGHT_BOUNDARY) {
            // move ball inside the boundaries
            this.position.x = (this.position.x <= Person.LEFT_BOUNDARY) ?
                Person.LEFT_BOUNDARY : Person.RIGHT_BOUNDARY;
            // reflection ball
            this.velocity.x = -this.velocity.x;
        }
        if (this.position.y <= Person.TOP_BOUNDARY || this.position.y >= Person.BOTTOM_BOUNDARY) {
            // move ball inside the borders
            this.position.y = (this.position.y <= Person.TOP_BOUNDARY) ?
                Person.TOP_BOUNDARY : Person.BOTTOM_BOUNDARY;
            // reflection ball
            this.velocity.y = -this.velocity.y;
        }
    }
    bordersCollision(leftBorder, rightBorder) {
        Person.borderCollision(leftBorder, this);
        Person.borderCollision(rightBorder, this);
    }
    ballsCollision(ball, infectionRate) {
        if (this.health === Health.DEAD || ball.health === Health.DEAD) {
            return;
        }
        this.positionDiff.set(this.position);
        this.positionDiff.sub(ball.position);
        const distance = this.positionDiff.length();
        const distanceDiff = (2 * PERSON_RADIUS) - distance; // 2* ballradius === minDistance
        if (distanceDiff >= 0) {
            if (this.socialDistancing) {
                Person.reflectBall(ball, this.positionDiff.negate(), distanceDiff);
            }
            else if (ball.socialDistancing) {
                Person.reflectBall(this, this.positionDiff, distanceDiff);
            }
            else {
                Person.separateBalls(this, ball, this.positionDiff, distanceDiff);
                if (!ball.socialDistancing || !this.socialDistancing) {
                    Person.ellasticCollision(this, ball, this.positionDiff, distance);
                }
            }
            if ((this.health === Health.SICK || ball.health === Health.SICK) &&
                (this.health === Health.HEALTHY || ball.health === Health.HEALTHY) &&
                (this.rng() < infectionRate)) {
                this.health = ball.health = Health.SICK;
            } // both will be sick if at least one is infected in the collision
        }
    }
    move() {
        if (!this.socialDistancing && this.health !== Health.DEAD) 
        // move the ball using velocities if not social distancing or dead
        {
            this.position = this.position.add(this.velocity);
        }
    }
    checkHealth(deathRate) {
        if (this.health === Health.SICK && (--this.timeToRecovery) === 0) 
        // check if this ball is dead or recovered
        {
            this.health = (this.rng() < deathRate) ? Health.DEAD : Health.RECOVERED;
        }
    }
}
Person.LEFT_BOUNDARY = PERSON_RADIUS;
Person.RIGHT_BOUNDARY = WIDTH - PERSON_RADIUS;
Person.TOP_BOUNDARY = PERSON_RADIUS;
Person.BOTTOM_BOUNDARY = HEIGHT - PERSON_RADIUS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc29uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vcGFuZGVtaWMtc2ltdWxhdG9yLWxpYi8iLCJzb3VyY2VzIjpbImxpYi9tb2RlbHMvcGVyc29uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3ZHLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkMsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUV0QyxNQUFNLE9BQU8sTUFBTTtJQWlCakIsWUFBbUIsTUFBYyxFQUFFLHFCQUFvQztRQUFwRCxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSHpCLGlCQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBSXhDLElBQUksQ0FBQyxHQUFHLEdBQUcscUJBQXFCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNoRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUM5QixnQkFBZ0IsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUNuRixDQUFDO0lBQ0osQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBa0I7UUFDbEMsT0FBTyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVyxDQUFDLElBQVksRUFBRSxTQUFtQixFQUFFLFlBQW9CO1FBQ3hFLFNBQVMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUV0QixxQ0FBcUM7UUFDckMsTUFBTSxJQUFJLEdBQUcsWUFBWSxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFeEQsU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3RCLHNIQUFzSDtRQUN0SCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RixDQUFDO0lBRUQsTUFBTSxDQUFDLGFBQWEsQ0FBQyxLQUFhLEVBQUUsS0FBYSxFQUFFLFdBQXFCLEVBQUUsWUFBb0I7UUFDNUYsa0NBQWtDO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLFlBQVksR0FBRyxDQUFDLEdBQUcsVUFBVSxDQUFDO1FBQzNDLE1BQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEQsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRCxLQUFLLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsTUFBTSxDQUFDLGlCQUFpQixDQUFDLEtBQWEsRUFBRSxLQUFhLEVBQUUsU0FBbUIsRUFBRSxRQUFnQjtRQUMxRixzR0FBc0c7UUFDdEcsaUZBQWlGO1FBQ2pGLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzdHLEtBQUssQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ25FLEtBQUssQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCxNQUFNLENBQUMsZUFBZSxDQUFDLE1BQWMsRUFBRSxJQUFZO1FBQ2pELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ2xCLE9BQU87U0FDUjtRQUVELElBQUksTUFBTSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRTtZQUM3RiwrQkFBK0I7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDdEQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUM7WUFFckQsZUFBZTtZQUNmLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRUQseUJBQXlCO1FBQ3ZCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsY0FBYyxFQUFFO1lBQ3ZGLGtDQUFrQztZQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO2dCQUMzRCxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDO1lBRS9DLGtCQUFrQjtZQUNsQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ3BDO1FBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxNQUFNLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUU7WUFDdkYsK0JBQStCO1lBQy9CLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7Z0JBQzFELE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7WUFFL0Msa0JBQWtCO1lBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsVUFBa0IsRUFBRSxXQUFtQjtRQUN0RCxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN6QyxNQUFNLENBQUMsZUFBZSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVksRUFBRSxhQUFxQjtRQUNoRCxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUU7WUFDOUQsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzVDLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLGdDQUFnQztRQUVyRixJQUFJLFlBQVksSUFBSSxDQUFDLEVBQUU7WUFDckIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ3pCLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLEVBQUUsWUFBWSxDQUFDLENBQUM7YUFDcEU7aUJBQU0sSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ2hDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7YUFDM0Q7aUJBQU07Z0JBQ0wsTUFBTSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7Z0JBRWxFLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7b0JBQ3BELE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsUUFBUSxDQUFDLENBQUM7aUJBQ25FO2FBQ0Y7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDOUQsQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsT0FBTyxDQUFDO2dCQUNsRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxhQUFhLENBQUMsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7YUFDekMsQ0FBRyxpRUFBaUU7U0FDdEU7SUFDSCxDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsSUFBSTtRQUN2RCxrRUFBa0U7UUFDcEU7WUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUNsRDtJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsU0FBaUI7UUFDM0IsSUFBSSxJQUFJLENBQUMsTUFBTSxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDO1FBQzlELDBDQUEwQztRQUM1QztZQUNFLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7U0FDekU7SUFDSCxDQUFDOztBQS9JZSxvQkFBYSxHQUFHLGFBQWEsQ0FBQztBQUM5QixxQkFBYyxHQUFHLEtBQUssR0FBRyxhQUFhLENBQUM7QUFDdkMsbUJBQVksR0FBRyxhQUFhLENBQUM7QUFDN0Isc0JBQWUsR0FBRyxNQUFNLEdBQUcsYUFBYSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm9yZGVyIH0gZnJvbSAnLi9ib3JkZXInO1xuaW1wb3J0IHsgSEVJR0hULCBQRVJTT05fR0FQLCBQRVJTT05fUkFESVVTLCBQRVJTT05fU1BFRUQsIHNpY2tuZXNzSW50ZXJ2YWwsIFdJRFRIIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgSGVhbHRoIH0gZnJvbSAnLi9oZWFsdGguZW51bSc7XG5pbXBvcnQgeyBWZWN0b3IyRCB9IGZyb20gJy4vdmVjdG9yMmQnO1xuXG5leHBvcnQgY2xhc3MgUGVyc29uIHtcblxuICBzdGF0aWMgcmVhZG9ubHkgTEVGVF9CT1VOREFSWSA9IFBFUlNPTl9SQURJVVM7XG4gIHN0YXRpYyByZWFkb25seSBSSUdIVF9CT1VOREFSWSA9IFdJRFRIIC0gUEVSU09OX1JBRElVUztcbiAgc3RhdGljIHJlYWRvbmx5IFRPUF9CT1VOREFSWSA9IFBFUlNPTl9SQURJVVM7XG4gIHN0YXRpYyByZWFkb25seSBCT1RUT01fQk9VTkRBUlkgPSBIRUlHSFQgLSBQRVJTT05fUkFESVVTO1xuXG4gIHBvc2l0aW9uOiBWZWN0b3IyRDtcbiAgc29jaWFsRGlzdGFuY2luZzogYm9vbGVhbjtcblxuXG4gIHByaXZhdGUgdmVsb2NpdHk6IFZlY3RvcjJEO1xuICBwcml2YXRlIHRpbWVUb1JlY292ZXJ5OiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBwb3NpdGlvbkRpZmYgPSBuZXcgVmVjdG9yMkQoMCwgMCk7XG4gIHByaXZhdGUgcm5nOiAoKSA9PiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IocHVibGljIGhlYWx0aDogSGVhbHRoLCByYW5kb21OdW1iZXJHZW5lcmF0b3I/OiAoKSA9PiBudW1iZXIpIHtcbiAgICB0aGlzLnJuZyA9IHJhbmRvbU51bWJlckdlbmVyYXRvciB8fCBNYXRoLnJhbmRvbTtcbiAgICB0aGlzLnBvc2l0aW9uID0gVmVjdG9yMkQucmFuZG9tKHRoaXMucm5nKTtcbiAgICB0aGlzLnBvc2l0aW9uLnggKj0gV0lEVEg7XG4gICAgdGhpcy5wb3NpdGlvbi55ICo9IEhFSUdIVDtcbiAgICB0aGlzLnZlbG9jaXR5ID0gUGVyc29uLmFwcGx5U3BlZWQoVmVjdG9yMkQucmFuZG9tKHRoaXMucm5nKS5zdWIobmV3IFZlY3RvcjJEKDAuNSwgMC41KSkpO1xuICAgIHRoaXMuc29jaWFsRGlzdGFuY2luZyA9IGZhbHNlO1xuICAgIHRoaXMudGltZVRvUmVjb3ZlcnkgPSBNYXRoLmZsb29yKFxuICAgICAgc2lja25lc3NJbnRlcnZhbC5mcm9tICsgdGhpcy5ybmcoKSAqIChzaWNrbmVzc0ludGVydmFsLnRvIC0gc2lja25lc3NJbnRlcnZhbC5mcm9tKVxuICAgICk7XG4gIH1cblxuICBzdGF0aWMgYXBwbHlTcGVlZCh2ZWxvY2l0eTogVmVjdG9yMkQpOiBWZWN0b3IyRCB7XG4gICAgcmV0dXJuIHZlbG9jaXR5Lm5vcm1hbGl6ZSgpLm11bHQoUEVSU09OX1NQRUVEKTtcbiAgfVxuXG4gIHN0YXRpYyByZWZsZWN0QmFsbChiYWxsOiBQZXJzb24sIGRpcmVjdGlvbjogVmVjdG9yMkQsIGRpc3RhbmNlRGlmZjogbnVtYmVyKTogdm9pZCB7XG4gICAgZGlyZWN0aW9uLm5vcm1hbGl6ZSgpO1xuXG4gICAgLy8gbW92ZSB0aGUgYmFsbCBvdXRzaWRlIG9mIGNvbGxpc2lvblxuICAgIGNvbnN0IGRpZmYgPSBkaXN0YW5jZURpZmYgKyBQRVJTT05fR0FQIC8gMjtcbiAgICBiYWxsLnBvc2l0aW9uID0gYmFsbC5wb3NpdGlvbi5hZGQoZGlyZWN0aW9uLm11bHQoZGlmZikpO1xuXG4gICAgZGlyZWN0aW9uLm5vcm1hbGl6ZSgpO1xuICAgIC8vIHJlZmxlY3QgYmFsbCwgc29sdXRpb246IHI9ZOKIkjIoZCpuKW4gKGh0dHBzOi8vbWF0aC5zdGFja2V4Y2hhbmdlLmNvbS9xdWVzdGlvbnMvMTMyNjEvaG93LXRvLWdldC1hLXJlZmxlY3Rpb24tdmVjdG9yKVxuICAgIGJhbGwudmVsb2NpdHkgPSBiYWxsLnZlbG9jaXR5LnN1YihkaXJlY3Rpb24ubXVsdCgyICogYmFsbC52ZWxvY2l0eS5kb3QoZGlyZWN0aW9uKSkpO1xuICB9XG5cbiAgc3RhdGljIHNlcGFyYXRlQmFsbHMoYmFsbEE6IFBlcnNvbiwgYmFsbEI6IFBlcnNvbiwgcG9zaXRpb25TdWI6IFZlY3RvcjJELCBkaXN0YW5jZURpZmY6IG51bWJlcik6IHZvaWQge1xuICAgIC8vIG1vdmUgYmFsbHMgb3V0c2lkZSBvZiBjb2xsaXNpb25cbiAgICBjb25zdCBkaWZmID0gZGlzdGFuY2VEaWZmIC8gMiArIFBFUlNPTl9HQVA7XG4gICAgY29uc3QgYWRqdXN0bWVudCA9IHBvc2l0aW9uU3ViLm5vcm1hbGl6ZSgpLm11bHQoZGlmZik7XG4gICAgYmFsbEEucG9zaXRpb24gPSBiYWxsQS5wb3NpdGlvbi5hZGQoYWRqdXN0bWVudCk7XG4gICAgYmFsbEIucG9zaXRpb24gPSBiYWxsQi5wb3NpdGlvbi5hZGQoYWRqdXN0bWVudC5uZWdhdGUoKSk7XG4gICAgcG9zaXRpb25TdWIubm9ybWFsaXplKCk7XG4gIH1cblxuICBzdGF0aWMgZWxsYXN0aWNDb2xsaXNpb24oYmFsbEE6IFBlcnNvbiwgYmFsbEI6IFBlcnNvbiwgZGlyZWN0aW9uOiBWZWN0b3IyRCwgZGlzdGFuY2U6IG51bWJlcik6IHZvaWQge1xuICAgIC8vIEVsYXN0aWMgY29sbGlzaW9uLCBidXQgdGhlIGJhbGwgc3BlZWQgaXMgcmV2ZXJ0ZWQgYWZ0ZXIgdGhlIGNvbGxpc2lvbiAobm8gZW5lcmd5IGxvc3QgaW4gdGhpcyBjYXNlKVxuICAgIC8vIFRoZSBmb3JtdWxhIGNhbiBiZSBmb3VuZCBoZXJlOiBodHRwczovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9FbGFzdGljX2NvbGxpc2lvblxuICAgIGNvbnN0IGFkanVzdG1lbnQgPSBkaXJlY3Rpb24ubXVsdChiYWxsQS52ZWxvY2l0eS5zdWIoYmFsbEIudmVsb2NpdHkpLmRvdChkaXJlY3Rpb24pIC8gKGRpc3RhbmNlICogZGlzdGFuY2UpKTtcbiAgICBiYWxsQS52ZWxvY2l0eSA9IFBlcnNvbi5hcHBseVNwZWVkKGJhbGxBLnZlbG9jaXR5LnN1YihhZGp1c3RtZW50KSk7XG4gICAgYmFsbEIudmVsb2NpdHkgPSBQZXJzb24uYXBwbHlTcGVlZChiYWxsQi52ZWxvY2l0eS5zdWIoYWRqdXN0bWVudC5uZWdhdGUoKSkpO1xuICB9XG5cbiAgc3RhdGljIGJvcmRlckNvbGxpc2lvbihib3JkZXI6IEJvcmRlciwgYmFsbDogUGVyc29uKTogdm9pZCB7XG4gICAgaWYgKCFib3JkZXIuY2xvc2VkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGJvcmRlci5iYWxsTGVmdFBvc2l0aW9uIDw9IGJhbGwucG9zaXRpb24ueCAmJiBib3JkZXIuYmFsbFJpZ2h0UG9zaXRpb24gPj0gYmFsbC5wb3NpdGlvbi54KSB7XG4gICAgICAvLyBtb3ZlIGJhbGwgb3V0c2lkZSB0aGUgYm9yZGVyXG4gICAgICBiYWxsLnBvc2l0aW9uLnggPSAoYmFsbC5wb3NpdGlvbi54IDw9IGJvcmRlci5wb3NpdGlvbikgP1xuICAgICAgICBib3JkZXIuYmFsbExlZnRQb3NpdGlvbiA6IGJvcmRlci5iYWxsUmlnaHRQb3NpdGlvbjtcblxuICAgICAgLy8gcmVmbGVjdCBiYWxsXG4gICAgICBiYWxsLnZlbG9jaXR5LnggPSAtYmFsbC52ZWxvY2l0eS54O1xuICAgIH1cbiAgfVxuXG4gIGNhbnZhc0JvdW5kYXJpZXNDb2xsaXNpb24oKTogdm9pZCB7XG4gICAgaWYgKHRoaXMucG9zaXRpb24ueCA8PSBQZXJzb24uTEVGVF9CT1VOREFSWSB8fCB0aGlzLnBvc2l0aW9uLnggPj0gUGVyc29uLlJJR0hUX0JPVU5EQVJZKSB7XG4gICAgICAvLyBtb3ZlIGJhbGwgaW5zaWRlIHRoZSBib3VuZGFyaWVzXG4gICAgICB0aGlzLnBvc2l0aW9uLnggPSAodGhpcy5wb3NpdGlvbi54IDw9IFBlcnNvbi5MRUZUX0JPVU5EQVJZKSA/XG4gICAgICAgIFBlcnNvbi5MRUZUX0JPVU5EQVJZIDogUGVyc29uLlJJR0hUX0JPVU5EQVJZO1xuXG4gICAgICAvLyByZWZsZWN0aW9uIGJhbGxcbiAgICAgIHRoaXMudmVsb2NpdHkueCA9IC10aGlzLnZlbG9jaXR5Lng7XG4gICAgfVxuICAgIGlmICh0aGlzLnBvc2l0aW9uLnkgPD0gUGVyc29uLlRPUF9CT1VOREFSWSB8fCB0aGlzLnBvc2l0aW9uLnkgPj0gUGVyc29uLkJPVFRPTV9CT1VOREFSWSkge1xuICAgICAgLy8gbW92ZSBiYWxsIGluc2lkZSB0aGUgYm9yZGVyc1xuICAgICAgdGhpcy5wb3NpdGlvbi55ID0gKHRoaXMucG9zaXRpb24ueSA8PSBQZXJzb24uVE9QX0JPVU5EQVJZKSA/XG4gICAgICAgIFBlcnNvbi5UT1BfQk9VTkRBUlkgOiBQZXJzb24uQk9UVE9NX0JPVU5EQVJZO1xuXG4gICAgICAvLyByZWZsZWN0aW9uIGJhbGxcbiAgICAgIHRoaXMudmVsb2NpdHkueSA9IC10aGlzLnZlbG9jaXR5Lnk7XG4gICAgfVxuICB9XG5cbiAgYm9yZGVyc0NvbGxpc2lvbihsZWZ0Qm9yZGVyOiBCb3JkZXIsIHJpZ2h0Qm9yZGVyOiBCb3JkZXIpOiB2b2lkIHtcbiAgICBQZXJzb24uYm9yZGVyQ29sbGlzaW9uKGxlZnRCb3JkZXIsIHRoaXMpO1xuICAgIFBlcnNvbi5ib3JkZXJDb2xsaXNpb24ocmlnaHRCb3JkZXIsIHRoaXMpO1xuICB9XG5cbiAgYmFsbHNDb2xsaXNpb24oYmFsbDogUGVyc29uLCBpbmZlY3Rpb25SYXRlOiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5oZWFsdGggPT09IEhlYWx0aC5ERUFEIHx8IGJhbGwuaGVhbHRoID09PSBIZWFsdGguREVBRCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnBvc2l0aW9uRGlmZi5zZXQodGhpcy5wb3NpdGlvbik7XG4gICAgdGhpcy5wb3NpdGlvbkRpZmYuc3ViKGJhbGwucG9zaXRpb24pO1xuICAgIGNvbnN0IGRpc3RhbmNlID0gdGhpcy5wb3NpdGlvbkRpZmYubGVuZ3RoKCk7XG4gICAgY29uc3QgZGlzdGFuY2VEaWZmID0gKDIgKiBQRVJTT05fUkFESVVTKSAtIGRpc3RhbmNlOyAvLyAyKiBiYWxscmFkaXVzID09PSBtaW5EaXN0YW5jZVxuXG4gICAgaWYgKGRpc3RhbmNlRGlmZiA+PSAwKSB7XG4gICAgICBpZiAodGhpcy5zb2NpYWxEaXN0YW5jaW5nKSB7XG4gICAgICAgIFBlcnNvbi5yZWZsZWN0QmFsbChiYWxsLCB0aGlzLnBvc2l0aW9uRGlmZi5uZWdhdGUoKSwgZGlzdGFuY2VEaWZmKTtcbiAgICAgIH0gZWxzZSBpZiAoYmFsbC5zb2NpYWxEaXN0YW5jaW5nKSB7XG4gICAgICAgIFBlcnNvbi5yZWZsZWN0QmFsbCh0aGlzLCB0aGlzLnBvc2l0aW9uRGlmZiwgZGlzdGFuY2VEaWZmKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFBlcnNvbi5zZXBhcmF0ZUJhbGxzKHRoaXMsIGJhbGwsIHRoaXMucG9zaXRpb25EaWZmLCBkaXN0YW5jZURpZmYpO1xuXG4gICAgICAgIGlmICghYmFsbC5zb2NpYWxEaXN0YW5jaW5nIHx8ICF0aGlzLnNvY2lhbERpc3RhbmNpbmcpIHtcbiAgICAgICAgICBQZXJzb24uZWxsYXN0aWNDb2xsaXNpb24odGhpcywgYmFsbCwgdGhpcy5wb3NpdGlvbkRpZmYsIGRpc3RhbmNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoKHRoaXMuaGVhbHRoID09PSBIZWFsdGguU0lDSyB8fCBiYWxsLmhlYWx0aCA9PT0gSGVhbHRoLlNJQ0spICYmXG4gICAgICAgICh0aGlzLmhlYWx0aCA9PT0gSGVhbHRoLkhFQUxUSFkgfHwgYmFsbC5oZWFsdGggPT09IEhlYWx0aC5IRUFMVEhZKSAmJlxuICAgICAgICAodGhpcy5ybmcoKSA8IGluZmVjdGlvblJhdGUpKSB7XG4gICAgICAgIHRoaXMuaGVhbHRoID0gYmFsbC5oZWFsdGggPSBIZWFsdGguU0lDSztcbiAgICAgIH0gICAvLyBib3RoIHdpbGwgYmUgc2ljayBpZiBhdCBsZWFzdCBvbmUgaXMgaW5mZWN0ZWQgaW4gdGhlIGNvbGxpc2lvblxuICAgIH1cbiAgfVxuXG4gIG1vdmUoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnNvY2lhbERpc3RhbmNpbmcgJiYgdGhpcy5oZWFsdGggIT09IEhlYWx0aC5ERUFEKVxuICAgICAgLy8gbW92ZSB0aGUgYmFsbCB1c2luZyB2ZWxvY2l0aWVzIGlmIG5vdCBzb2NpYWwgZGlzdGFuY2luZyBvciBkZWFkXG4gICAge1xuICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMucG9zaXRpb24uYWRkKHRoaXMudmVsb2NpdHkpO1xuICAgIH1cbiAgfVxuXG4gIGNoZWNrSGVhbHRoKGRlYXRoUmF0ZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaGVhbHRoID09PSBIZWFsdGguU0lDSyAmJiAoLS10aGlzLnRpbWVUb1JlY292ZXJ5KSA9PT0gMClcbiAgICAgIC8vIGNoZWNrIGlmIHRoaXMgYmFsbCBpcyBkZWFkIG9yIHJlY292ZXJlZFxuICAgIHtcbiAgICAgIHRoaXMuaGVhbHRoID0gKHRoaXMucm5nKCkgPCBkZWF0aFJhdGUpID8gSGVhbHRoLkRFQUQgOiBIZWFsdGguUkVDT1ZFUkVEO1xuICAgIH1cbiAgfVxufVxuIl19